{
  "paths": {
  "/admin/ebay/metrics": {"get": {"summary": "Get eBay integration metrics snapshot","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"responses":{"200":{"description":"Metrics","content":{"application/json":{"schema":{"$ref":"#/components/schemas/MetricsSnapshot"},"example":{"counters":{"drift.detected":12,"queue.processed":150},"gauges":{"queue.depth":3},"timestamps":{"lastDriftDetected":"2025-08-18T10:00:00Z"}}}}},"500":{"description":"Server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"},"example":{"error":"internal_error","message":"Unexpected failure"}}}}}}},
  "/admin/ebay/health": {"get": {"summary": "Get eBay integration health summary","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"responses":{"200":{"description":"Health","content":{"application/json":{"schema":{"$ref":"#/components/schemas/HealthSummary"},"example":{"featureFlags":{"DRIFT_RETENTION_ENABLED":true},"metrics":{"queue.depth":3},"summary":{"changeDetector.msSinceLastRun":5231,"retention.msSinceLastRun":86400000}}}}},"500":{"description":"Server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"}}}}}}},
  "/admin/ebay/transactions": {"get": {"summary": "List transaction log entries","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"parameters":[{"in":"query","name":"channel","schema":{"type":"string"}},{"in":"query","name":"operation","schema":{"type":"string"}},{"in":"query","name":"status","schema":{"type":"string"}},{"in":"query","name":"ebay_listing_id","schema":{"type":"integer"}},{"in":"query","name":"from","schema":{"type":"string","format":"date-time"}},{"in":"query","name":"to","schema":{"type":"string","format":"date-time"}},{"in":"query","name":"limit","schema":{"type":"integer","default":100}},{"in":"query","name":"offset","schema":{"type":"integer","default":0}},{"in":"query","name":"format","schema":{"type":"string","enum":["json","csv"],"default":"json"}}],"responses":{"200":{"description":"Transactions JSON or CSV","content":{"application/json":{"schema":{"$ref":"#/components/schemas/TransactionList"},"example":{"items":[{"txn_id":1,"ebay_listing_id":10,"operation":"CREATE_LISTING","status":"success","latency_ms":345,"created_at":"2025-08-18T09:59:00Z"}],"pagination":{"limit":100,"offset":0,"count":1,"total":250}}}}}}}},
  "/admin/ebay/queue": {"get": {"summary":"List change queue items","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"responses":{"200":{"description":"Queue items","content":{"application/json":{"schema":{"$ref":"#/components/schemas/QueueItemList"},"example":{"items":[{"queue_id":101,"ebay_listing_id":10,"intent":"updatePrice","status":"pending"}],"pagination":{"limit":100,"offset":0,"count":1,"total":4}}}}}}}},
  "/admin/ebay/queue/{id}/retry": {"post": {"summary":"Retry a queue item","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"integer"}}],"responses":{"200":{"description":"Retried"},"404":{"description":"Not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"},"example":{"error":"not_found","message":"Queue item not found"}}}},"500":{"description":"Server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"}}}}}}},
  "/admin/ebay/queue/dead-letter": {"get": {"summary":"List dead queue + failed events","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"responses":{"200":{"description":"Dead letters","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DeadLetterSet"},"example":{"dead":[],"failed":[{"failed_event_id":5,"ebay_listing_id":11,"intent":"updateQuantity","last_error":"timeout"}]}}}}}}},
  "/admin/ebay/failed-events/{id}/replay": {"post": {"summary":"Replay failed event","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"integer"}}],"responses":{"200":{"description":"Replayed"},"404":{"description":"Not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"}}}}}}},
  "/admin/ebay/snapshots": {"get": {"summary":"List snapshots","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"parameters":[{"in":"query","name":"ebay_listing_id","schema":{"type":"integer"}},{"in":"query","name":"limit","schema":{"type":"integer"}}],"responses":{"200":{"description":"Snapshots","content":{"application/json":{"schema":{"$ref":"#/components/schemas/SnapshotList"},"example":{"items":[{"snapshot_id":10,"ebay_listing_id":1,"snapshot_hash":"abc123","created_at":"2025-08-18T09:00:00Z"}]}}}}}}},
  "/admin/ebay/snapshots/{id}": {"get": {"summary":"Get snapshot by id","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"parameters":[{"in":"path","name":"id","required":true,"schema":{"type":"integer"}}],"responses":{"200":{"description":"Snapshot","content":{"application/json":{"schema":{"$ref":"#/components/schemas/EbayListingSnapshot"}}}},"404":{"description":"Not found","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"}}}}}}},
  "/admin/ebay/snapshots/{a}/diff/{b}": {"get": {"summary":"Diff two snapshots","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"parameters":[{"in":"path","name":"a","required":true,"schema":{"type":"integer"}},{"in":"path","name":"b","required":true,"schema":{"type":"integer"}}],"responses":{"200":{"description":"Diff","content":{"application/json":{"schema":{"type":"object","properties":{"added":{"type":"array","items":{"type":"string"}},"removed":{"type":"array","items":{"type":"string"}},"changed":{"type":"array","items":{"type":"string"}}}}}}}}}},
  "/admin/ebay/sync/logs": {"get": {"summary":"List sync log entries","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"responses":{"200":{"description":"Sync logs","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object"}}}}}}}}}},
  "/admin/ebay/policies": {"get": {"summary":"List cached policies","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"responses":{"200":{"description":"Policies","content":{"application/json":{"schema":{"type":"object","properties":{"items":{"type":"array","items":{"type":"object"}}}}}}}}}},
  "/admin/ebay/drift-events": {"get": {"summary":"List drift events","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"parameters":[{"in":"query","name":"classification","schema":{"type":"string","enum":["internal_only","external_only","both_changed","snapshot_stale"]}},{"in":"query","name":"listingId","schema":{"type":"integer"}},{"in":"query","name":"fromMs","schema":{"type":"integer"}},{"in":"query","name":"toMs","schema":{"type":"integer"}},{"in":"query","name":"limit","schema":{"type":"integer"}},{"in":"query","name":"offset","schema":{"type":"integer"}}],"responses":{"200":{"description":"Drift events","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DriftEventsList"},"example":{"items":[{"drift_event_id":1,"ebay_listing_id":10,"classification":"external_only","created_at":"2025-08-18T10:00:00Z"}],"pagination":{"limit":100,"offset":0,"count":1,"total":53}}}}}}}},
  "/admin/ebay/drift-events/summary": {"get": {"summary":"Drift classification counts","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"responses":{"200":{"description":"Counts","content":{"application/json":{"schema":{"$ref":"#/components/schemas/DriftSummary"},"example":{"counts":{"external_only":20,"internal_only":5,"both_changed":3,"snapshot_stale":1}}}}}}}},
  "/admin/ebay/drift-events/retention/run": {"post": {"summary":"Trigger drift retention","tags":["eBay Admin"],"security":[{"AdminHeaderAuth":[]}],"requestBody":{"required":false,"content":{"application/json":{"schema":{"type":"object","properties":{"retentionDays":{"type":"integer","minimum":1}}}}}},"responses":{"200":{"description":"Retention result","content":{"application/json":{"schema":{"$ref":"#/components/schemas/RetentionResult"},"example":{"deleted":42,"retentionDays":30,"cutoff":"2025-07-19T00:00:00Z","skipped":false}}}},"500":{"description":"Server error","content":{"application/json":{"schema":{"$ref":"#/components/schemas/ErrorResponse"}}}}}}}
  }
  ,"components":{
    "securitySchemes":{"AdminHeaderAuth":{"type":"apiKey","in":"header","name":"X-Admin-Auth"}},
    "schemas":{
      "ErrorResponse":{"type":"object","properties":{"error":{"type":"string"},"message":{"type":"string"},"code":{"type":"string"},"details":{"type":"object"}},"required":["error","message"]},
      "HealthSummary":{"type":"object","properties":{"featureFlags":{"type":"object"},"metrics":{"type":"object"},"summary":{"type":"object"}}},
      "MetricsSnapshot":{"type":"object","properties":{"counters":{"type":"object"},"gauges":{"type":"object"},"timestamps":{"type":"object"}}},
      "TransactionList":{"type":"object","properties":{"items":{"type":"array","items":{"$ref":"#/components/schemas/EbayTransactionLog"}},"pagination":{"$ref":"#/components/schemas/Pagination"}}},
      "QueueItemList":{"type":"object","properties":{"items":{"type":"array","items":{"$ref":"#/components/schemas/EbayChangeQueue"}},"pagination":{"$ref":"#/components/schemas/Pagination"}}},
      "DeadLetterSet":{"type":"object","properties":{"dead":{"type":"array","items":{"$ref":"#/components/schemas/EbayChangeQueue"}},"failed":{"type":"array","items":{"$ref":"#/components/schemas/EbayFailedEvent"}}}},
      "SnapshotList":{"type":"object","properties":{"items":{"type":"array","items":{"$ref":"#/components/schemas/EbayListingSnapshot"}}}},
      "DriftEventsList":{"type":"object","properties":{"items":{"type":"array","items":{"$ref":"#/components/schemas/EbayDriftEvent"}},"pagination":{"$ref":"#/components/schemas/Pagination"}}},
      "DriftSummary":{"type":"object","properties":{"counts":{"type":"object","additionalProperties":{"type":"integer"}}}},
      "RetentionResult":{"type":"object","properties":{"deleted":{"type":"integer"},"retentionDays":{"type":"integer"},"cutoff":{"type":"string","format":"date-time"},"skipped":{"type":"boolean"}}},
      "Pagination":{"type":"object","properties":{"limit":{"type":"integer"},"offset":{"type":"integer"},"count":{"type":"integer"},"total":{"type":"integer"}}},
      "EbayChangeQueue":{"type":"object","properties":{"queue_id":{"type":"integer"},"ebay_listing_id":{"type":"integer"},"intent":{"type":"string"},"payload_hash":{"type":"string"},"status":{"type":"string"},"priority":{"type":"integer"},"attempts":{"type":"integer"},"error_reason":{"type":"string"},"next_earliest_run_at":{"type":"string","format":"date-time"},"last_attempt_at":{"type":"string","format":"date-time"},"created_at":{"type":"string","format":"date-time"},"updated_at":{"type":"string","format":"date-time"}}},
      "EbayFailedEvent":{"type":"object","properties":{"failed_event_id":{"type":"integer"},"ebay_listing_id":{"type":"integer"},"intent":{"type":"string"},"payload_hash":{"type":"string"},"request_payload":{"type":"object"},"last_error":{"type":"string"},"attempts":{"type":"integer"},"last_attempt_at":{"type":"string","format":"date-time"},"created_at":{"type":"string","format":"date-time"}}},
      "EbayListingSnapshot":{"type":"object","properties":{"snapshot_id":{"type":"integer"},"ebay_listing_id":{"type":"integer"},"snapshot_hash":{"type":"string"},"snapshot_json":{"type":"object"},"diff_from_prev_json":{"type":"object"},"source_event":{"type":"string"},"dedup_of_snapshot_id":{"type":"integer"},"created_at":{"type":"string","format":"date-time"}}},
      "EbayTransactionLog":{"type":"object","properties":{"txn_id":{"type":"integer"},"ebay_listing_id":{"type":"integer"},"correlation_id":{"type":"string"},"direction":{"type":"string"},"channel":{"type":"string"},"operation":{"type":"string"},"request_url":{"type":"string"},"request_method":{"type":"string"},"request_body":{"type":"object"},"response_code":{"type":"integer"},"response_body":{"type":"object"},"status":{"type":"string"},"error_classification":{"type":"string"},"latency_ms":{"type":"integer"},"created_at":{"type":"string","format":"date-time"}}},
      "EbayDriftEvent":{"type":"object","properties":{"drift_event_id":{"type":"integer"},"ebay_listing_id":{"type":"integer"},"classification":{"type":"string","enum":["internal_only","external_only","both_changed","snapshot_stale"]},"local_hash":{"type":"string"},"remote_hash":{"type":"string"},"snapshot_hash":{"type":"string"},"details_json":{"type":"object"},"created_at":{"type":"string","format":"date-time"}}}
    }
  }
}
